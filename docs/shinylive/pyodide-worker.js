"use strict";var Q=Object.create;var O=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty;var L=(e=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(e,{get:(t,r)=>(typeof require!="undefined"?require:t)[r]}):e)(function(e){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+e+'" is not supported')});var re=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var se=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Z(t))!te.call(e,n)&&n!==r&&O(e,n,{get:()=>t[n],enumerable:!(s=Y(t,n))||s.enumerable});return e};var ne=(e,t,r)=>(r=e!=null?Q(ee(e)):{},se(t||!e||!e.__esModule?O(r,"default",{value:e,enumerable:!0}):r,e));var q=re((Re,F)=>{"use strict";F.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}});var P=class{constructor(){this._buffer=[];this._resolve=null,this._promise=null,this._notifyAll()}async _wait(){await this._promise}_notifyAll(){this._resolve&&this._resolve(),this._promise=new Promise(t=>this._resolve=t)}async dequeue(){for(;this._buffer.length===0;)await this._wait();return this._buffer.shift()}enqueue(t){this._buffer.push(t),this._notifyAll()}};function R(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}async function k(e,t,r,s){let n=s.runPython(`_shiny_app_registry["${t}"].app.call_pyodide`);await ae(e,r,n)}async function ae(e,t,r){let s=new P;t.addEventListener("message",o=>{o.data.type==="http.request"&&s.enqueue({type:"http.request",body:o.data.body,more_body:o.data.more_body})}),t.start();async function n(){return s.dequeue()}async function a(o){if(o=Object.fromEntries(o.toJs()),o.type==="http.response.start")t.postMessage({type:o.type,status:o.status,headers:ie(o.headers)});else if(o.type==="http.response.body")t.postMessage({type:o.type,body:o.body,more_body:o.more_body});else throw new Error(`Unhandled ASGI event: ${o.type}`)}await r(e,n,a)}function ie(e){return e=e.map(([t,r])=>[R(t),R(r)]),Object.fromEntries(e)}var _=class extends EventTarget{constructor(r){super();this.readyState=0,this.addEventListener("open",s=>{this.onopen&&this.onopen(s)}),this.addEventListener("message",s=>{this.onmessage&&this.onmessage(s)}),this.addEventListener("error",s=>{this.onerror&&this.onerror(s)}),this.addEventListener("close",s=>{this.onclose&&this.onclose(s)}),this._port=r,r.addEventListener("message",this._onMessage.bind(this)),r.start()}accept(){this.readyState===0&&(this.readyState=1,this._port.postMessage({type:"open"}))}send(r){if(this.readyState===0)throw new DOMException("Can't send messages while WebSocket is in CONNECTING state","InvalidStateError");this.readyState>1||this._port.postMessage({type:"message",value:{data:r}})}close(r,s){this.readyState>1||(this.readyState=2,this._port.postMessage({type:"close",value:{code:r,reason:s}}),this.readyState=3,this.dispatchEvent(new CloseEvent("close",{code:r,reason:s})))}_onMessage(r){let s=r.data;switch(s.type){case"open":if(this.readyState===0){this.readyState=1,this.dispatchEvent(new Event("open"));return}break;case"message":if(this.readyState===1){this.dispatchEvent(new MessageEvent("message",{...s.value}));return}break;case"close":if(this.readyState<3){this.readyState=3,this.dispatchEvent(new CloseEvent("close",{...s.value}));return}break}this._reportError(`Unexpected event '${s.type}' while in readyState ${this.readyState}`,1002)}_reportError(r,s){this.dispatchEvent(new ErrorEvent("error",{message:r})),typeof s=="number"&&this.close(s,r)}};async function S(e,t,r,s){let n=new _(r),a=s.runPython(`_shiny_app_registry["${t}"].app.call_pyodide`);await le(e,n,a)}async function le(e,t,r){let s={type:"websocket",asgi:{version:"3.0",spec_version:"2.1"},path:e,headers:[]},n=new P;n.enqueue({type:"websocket.connect"});async function a(){return await n.dequeue()}async function o(p){if(p=Object.fromEntries(p.toJs()),p.type==="websocket.accept")t.accept();else if(p.type==="websocket.send")t.send(p.text??p.bytes);else if(p.type==="websocket.close")t.close(p.code,p.reason);else throw t.close(1002,"ASGI protocol error"),new Error(`Unhandled ASGI event: ${p.type}`)}t.addEventListener("message",p=>{let y=p,i={type:"websocket.receive"};typeof y.data=="string"?i.text=y.data:i.bytes=y.data,n.enqueue(i)}),t.addEventListener("close",p=>{let y=p;n.enqueue({type:"websocket.disconnect",code:y.code})}),t.addEventListener("error",p=>{console.error(p)}),await r(s,a,o)}function U(e){let t={message:"An unknown error occured",name:e.name};return e instanceof Error&&(t.message=e.message,e.stack&&(t.stack=e.stack)),t}var h,W,E,$,pe={exports:{}},j={exports:{}};j.exports=function(){function e(l){return!isNaN(parseFloat(l))&&isFinite(l)}function t(l){return l.charAt(0).toUpperCase()+l.substring(1)}function r(l){return function(){return this[l]}}var s=["isConstructor","isEval","isNative","isToplevel"],n=["columnNumber","lineNumber"],a=["fileName","functionName","source"],o=["args"],p=["evalOrigin"],y=s.concat(n,a,o,p);function i(l){if(l)for(var u=0;u<y.length;u++)l[y[u]]!==void 0&&this["set"+t(y[u])](l[y[u]])}i.prototype={getArgs:function(){return this.args},setArgs:function(l){if(Object.prototype.toString.call(l)!=="[object Array]")throw new TypeError("Args must be an Array");this.args=l},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(l){if(l instanceof i)this.evalOrigin=l;else{if(!(l instanceof Object))throw new TypeError("Eval Origin must be an Object or StackFrame");this.evalOrigin=new i(l)}},toString:function(){var l=this.getFileName()||"",u=this.getLineNumber()||"",m=this.getColumnNumber()||"",w=this.getFunctionName()||"";return this.getIsEval()?l?"[eval] ("+l+":"+u+":"+m+")":"[eval]:"+u+":"+m:w?w+" ("+l+":"+u+":"+m+")":l+":"+u+":"+m}},i.fromString=function(l){var u=l.indexOf("("),m=l.lastIndexOf(")"),w=l.substring(0,u),B=l.substring(u+1,m).split(","),I=l.substring(m+1);if(I.indexOf("@")===0)var x=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(I,""),V=x[1],z=x[2],X=x[3];return new i({functionName:w,args:B||void 0,fileName:V,lineNumber:z||void 0,columnNumber:X||void 0})};for(var c=0;c<s.length;c++)i.prototype["get"+t(s[c])]=r(s[c]),i.prototype["set"+t(s[c])]=function(l){return function(u){this[l]=Boolean(u)}}(s[c]);for(var d=0;d<n.length;d++)i.prototype["get"+t(n[d])]=r(n[d]),i.prototype["set"+t(n[d])]=function(l){return function(u){if(!e(u))throw new TypeError(l+" must be a Number");this[l]=Number(u)}}(n[d]);for(var f=0;f<a.length;f++)i.prototype["get"+t(a[f])]=r(a[f]),i.prototype["set"+t(a[f])]=function(l){return function(u){this[l]=String(u)}}(a[f]);return i}();var ce=pe.exports=(h=j.exports,W=/(^|@)\S+:\d+/,E=/^\s*at .*(\S+:\d+|\(native\))/m,$=/^(eval@)?(\[native code])?$/,{parse:function(e){if(e.stacktrace!==void 0||e["opera#sourceloc"]!==void 0)return this.parseOpera(e);if(e.stack&&e.stack.match(E))return this.parseV8OrIE(e);if(e.stack)return this.parseFFOrSafari(e);throw new Error("Cannot parse given Error object")},extractLocation:function(e){if(e.indexOf(":")===-1)return[e];var t=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(e.replace(/[()]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]},parseV8OrIE:function(e){return e.stack.split(`
`).filter(function(t){return!!t.match(E)},this).map(function(t){t.indexOf("(eval ")>-1&&(t=t.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var r=t.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),s=r.match(/ (\(.+\)$)/);r=s?r.replace(s[0],""):r;var n=this.extractLocation(s?s[1]:r),a=s&&r||void 0,o=["eval","<anonymous>"].indexOf(n[0])>-1?void 0:n[0];return new h({functionName:a,fileName:o,lineNumber:n[1],columnNumber:n[2],source:t})},this)},parseFFOrSafari:function(e){return e.stack.split(`
`).filter(function(t){return!t.match($)},this).map(function(t){if(t.indexOf(" > eval")>-1&&(t=t.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),t.indexOf("@")===-1&&t.indexOf(":")===-1)return new h({functionName:t});var r=/((.*".+"[^@]*)?[^@]*)(?:@)/,s=t.match(r),n=s&&s[1]?s[1]:void 0,a=this.extractLocation(t.replace(r,""));return new h({functionName:n,fileName:a[0],lineNumber:a[1],columnNumber:a[2],source:t})},this)},parseOpera:function(e){return!e.stacktrace||e.message.indexOf(`
`)>-1&&e.message.split(`
`).length>e.stacktrace.split(`
`).length?this.parseOpera9(e):e.stack?this.parseOpera11(e):this.parseOpera10(e)},parseOpera9:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)/i,r=e.message.split(`
`),s=[],n=2,a=r.length;n<a;n+=2){var o=t.exec(r[n]);o&&s.push(new h({fileName:o[2],lineNumber:o[1],source:r[n]}))}return s},parseOpera10:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,r=e.stacktrace.split(`
`),s=[],n=0,a=r.length;n<a;n+=2){var o=t.exec(r[n]);o&&s.push(new h({functionName:o[3]||void 0,fileName:o[2],lineNumber:o[1],source:r[n]}))}return s},parseOpera11:function(e){return e.stack.split(`
`).filter(function(t){return!!t.match(W)&&!t.match(/^Error created at/)},this).map(function(t){var r,s=t.split("@"),n=this.extractLocation(s.pop()),a=s.shift()||"",o=a.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0;a.match(/\(([^)]*)\)/)&&(r=a.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var p=r===void 0||r==="[arguments not available]"?void 0:r.split(",");return new h({functionName:o,args:p,fileName:n[0],lineNumber:n[1],columnNumber:n[2],source:t})},this)}}),M=typeof process<"u"&&process.release&&process.release.name==="node"&&process.browser===void 0,J,T,K,G,H,v;if(H=M?async function(e,t,r){if(t.startsWith("/")||t.includes("://")||(t=`${e}${t}`),t.startsWith("file://")&&(t=t.slice(7)),t.includes("://")){let s=await T(t);if(!s.ok)throw new Error(`Failed to load '${t}': request failed.`);return new Uint8Array(await s.arrayBuffer())}{let s=await G.readFile(t);return new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}}:async function(e,t,r){let s=new URL(e,location),n=new URL(t,s),a=r?{integrity:r}:{},o=await fetch(n,a);if(!o.ok)throw new Error(`Failed to load '${n}': request failed.`);return new Uint8Array(await o.arrayBuffer())},globalThis.document)v=async e=>await import(e);else if(globalThis.importScripts)v=async e=>{try{globalThis.importScripts(e)}catch(t){if(!(t instanceof TypeError))throw t;await import(e)}};else{if(!M)throw new Error("Cannot determine runtime environment");v=async function(e){e.startsWith("file://")&&(e=e.slice(7)),e.includes("://")?K.runInThisContext(await(await T(e)).text()):await import(J.pathToFileURL(e).href)}}function de(e,t,r,s){r&&(e.print=r),s&&(e.printErr=s),t&&e.preRun.push(function(){e.FS.init(function(n){let a=new TextEncoder,o=new Uint8Array(0),p=-1;function y(){try{if(p===-1){let i=n();if(i==null)return null;if(typeof i!="string")throw new TypeError(`Expected stdin to return string, null, or undefined, got type ${typeof i}.`);i.endsWith(`
`)||(i+=`
`),o=a.encode(i),p=0}if(p<o.length){let i=o[p];return p++,i}return p=-1,null}catch(i){throw console.error("Error thrown in stdin:"),console.error(i),i}}return y}(t),null,null)})}function ye(e,t){e.runPythonInternal_dict=e._pyodide._base.eval_code("{}"),e.importlib=e.runPythonInternal("import importlib; importlib");let r=e.importlib.import_module;e.sys=r("sys"),e.sys.path.insert(0,t.homedir);let s=e.runPythonInternal("import __main__; __main__.__dict__"),n=e.runPythonInternal("import builtins; builtins.__dict__");var a;e.globals=(a=n,new Proxy(s,{get:(y,i)=>i==="get"?c=>{let d=y.get(c);return d===void 0&&(d=a.get(c)),d}:i==="has"?c=>y.has(c)||a.has(c):Reflect.get(y,i)}));let o=e._pyodide._importhook;o.register_js_finder(),o.register_js_module("js",t.jsglobals);let p=e.makePublicAPI();return o.register_js_module("pyodide_js",p),e.pyodide_py=r("pyodide"),e.pyodide_code=r("pyodide.code"),e.pyodide_ffi=r("pyodide.ffi"),e.package_loader=r("pyodide._package_loader"),e.version=e.pyodide_py.__version__,p.pyodide_py=e.pyodide_py,p.version=e.version,p.globals=e.globals,p}async function C(e={}){e.indexURL||(e.indexURL=function(){let c;try{throw new Error}catch(l){c=l}let d=ce.parse(c)[0].fileName,f=d.includes("/")?d.lastIndexOf("/"):d.lastIndexOf("\\");if(f===-1)throw new Error("Could not extract indexURL path from pyodide module location");return d.slice(0,f)}()),e.indexURL.endsWith("/")||(e.indexURL+="/");let t={fullStdLib:!0,jsglobals:globalThis,stdin:globalThis.prompt?globalThis.prompt:void 0,homedir:"/home/pyodide",lockFileURL:e.indexURL+"repodata.json"},r=Object.assign(t,e);await async function(){if(!M||(J=(await import("url")).default,G=await import("fs/promises"),T=globalThis.fetch?fetch:(await import("node-fetch")).default,K=(await import("vm")).default,typeof L<"u"))return;let c={fs:await import("fs"),crypto:await import("crypto"),ws:await Promise.resolve().then(()=>ne(q())),child_process:await import("child_process")};globalThis.require=function(d){return c[d]}}();let s=H(r.indexURL,"pyodide_py.tar"),n={noImageDecoding:!0,noAudioDecoding:!0,noWasmDecoding:!1,preloadedWasm:{},preRun:[]},a={config:r};n.API=a,de(n,r.stdin,r.stdout,r.stderr),function(c,d){c.preRun.push(function(){try{c.FS.mkdirTree(d)}catch(f){console.error(`Error occurred while making a home directory '${d}':`),console.error(f),console.error("Using '/' for a home directory instead"),d="/"}c.ENV.HOME=d,c.FS.chdir(d)})}(n,r.homedir);let o=new Promise(c=>n.postRun=c);n.locateFile=c=>r.indexURL+c;let p=`${r.indexURL}pyodide.asm.js`;await v(p),await _createPyodideModule(n),await o,n.locateFile=c=>{throw new Error("Didn't expect to load any more file_packager files!")};let y=await s;(function(c,d){let f=c.FS.open("/pyodide_py.tar","w");c.FS.write(f,d,0,d.byteLength,void 0,!0),c.FS.close(f);let l=c.stringToNewUTF8(`
from sys import version_info
pyversion = f"python{version_info.major}.{version_info.minor}"
import shutil
shutil.unpack_archive("/pyodide_py.tar", f"/lib/{pyversion}/site-packages/")
del shutil
import importlib
importlib.invalidate_caches()
del importlib
    `);if(c._PyRun_SimpleString(l))throw new Error("OOPS!");c._free(l),c.FS.unlink("/pyodide_py.tar")})(n,y),n._pyodide_init();let i=ye(a,r);if(i.version.includes("dev")||a.setCdnUrl(`https://cdn.jsdelivr.net/pyodide/v${i.version}/full/`),await a.packageIndexReady,a.repodata_info.version!==i.version)throw new Error("Lock file version doesn't match Pyodide version");return r.fullStdLib&&await i.loadPackage(["distutils"]),i.runPython("print('Python initialization complete')"),i}async function D(e,t){let r=e.globals.get("repr");e.globals.set("js_pyodide",e);let s=await e.runPythonAsync(`
  import pyodide.console
  import __main__
  pyodide.console.PyodideConsole(__main__.__dict__)
  `),n=s.complete.copy();s.destroy(),t&&e.globals.set("callJS",t);let a=await e.runPythonAsync(`
  def _short_format_last_traceback() -> str:
      import sys
      import traceback
      e = sys.last_value
      found_marker = False
      nframes = 0
      for (frame, _) in traceback.walk_tb(e.__traceback__):
          if frame.f_code.co_filename in ("<console>", "<exec>"):
              found_marker = True
          if found_marker:
              nframes += 1
      return "".join(traceback.format_exception(type(e), e, e.__traceback__, -nframes))

  _short_format_last_traceback
  `);return await e.runPythonAsync("del _short_format_last_traceback"),{repr:r,tabComplete:n,shortFormatLastTraceback:a}}function A(e,t="none",r,s){return{get value(){return r.isPyProxy(e)?e.toJs():e},get printed_value(){return s(e)},get to_html(){let a;try{a=r.globals.get("_to_html")}catch(p){console.error("Couldn't find _to_html function: ",p),a=y=>({type:"text",value:"Couldn't finding _to_html function."})}return a(e).toJs({dict_converter:Object.fromEntries})},get none(){}}[t]}var N="none",g;self.stdout_callback=function(e){self.postMessage({type:"nonreply",subtype:"output",stdout:e})};self.stderr_callback=function(e){self.postMessage({type:"nonreply",subtype:"output",stderr:e})};async function ue(e,t){self.postMessage({type:"nonreply",subtype:"callJS",fnName:e.toJs(),args:t.toJs()})}var b;self.onmessage=async function(e){let t=e.data;if(t.type==="openChannel"){let s=e.ports[0];S(t.path,t.appName,s,g);return}else if(t.type==="makeRequest"){let s=e.ports[0];k(t.scope,t.appName,s,g);return}let r=e.ports[0];try{if(t.type==="init")N==="none"&&(N="loading",g=await C({...t.config,stdout:self.stdout_callback,stderr:self.stderr_callback}),b=await D(g,ue),N="loaded"),r.postMessage({type:"reply",subtype:"done"});else if(t.type==="loadPackagesFromImports")await g.loadPackagesFromImports(t.code);else if(t.type==="runPythonAsync"){await g.loadPackagesFromImports(t.code);let s=await g.runPythonAsync(t.code);t.printResult&&s!==void 0&&self.stdout_callback(b.repr(s));try{let n=A(s,t.returnResult,g,b.repr);r.postMessage({type:"reply",subtype:"done",value:n})}finally{g.isPyProxy(s)&&s.destroy()}}else if(t.type==="tabComplete"){let s=b.tabComplete(t.code).toJs()[0];r.postMessage({type:"reply",subtype:"tabCompletions",completions:s})}else if(t.type==="callPyAsync"){let{fnName:s,args:n,kwargs:a}=t,o=g.globals.get(s[0]);for(let i of s.slice(1))o=o[i];let p=o.callKwargs(...n,a),y=await Promise.resolve(p);t.printResult&&y!==void 0&&self.stdout_callback(b.repr(y));try{let i=A(y,t.returnResult,g,b.repr);r.postMessage({type:"reply",subtype:"done",value:i})}finally{g.isPyProxy(y)&&y.destroy()}}else r.postMessage({type:"reply",subtype:"done",error:new Error(`Unknown message type: ${t.toString()}`)})}catch(s){s instanceof g.PythonError&&(s.message=b.shortFormatLastTraceback()),r.postMessage({type:"reply",subtype:"done",error:U(s)})}};
